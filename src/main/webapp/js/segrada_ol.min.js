(function(c){var e=new Bloodhound({datumTokenizer:function(f){return Bloodhound.tokenizers.whitespace(f.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:"http://nominatim.openstreetmap.org/search?format=json&q=%QUERY",transform:function(g){var f=[];for(var h=0;h<g.length;h++){f.push({title:g[h].display_name,lng:g[h].lon,lat:g[h].lat})}return f}}});function d(j,l){var i=parseFloat(j.attr("data-lat"));var g=parseFloat(j.attr("data-lng"));var k=j.attr("data-comment");if(typeof k!="undefined"&&k!=""){k="<p>"+escapeHTML(k)+"</p>"}else{k=""}var f=new ol.geom.Point(ol.proj.transform([g,i],"EPSG:4326","EPSG:3857"));var h=new ol.Feature({geometry:f,data_id:j.html(),lat:i,lng:g,delete_ok:j.attr("data-delete-ok")==="1",delete_url:j.attr("data-delete"),comment:k});l.addFeature(h)}function a(f,g){g.clear(true);console.log(g);c(".sg-location-marker",f).each(function(){d(c(this),g)})}function b(f){f=f||c("body");c(".sg-geotab",f).on("shown.bs.tab",function(n){var o=c(n.target);if(o.attr("data-created")=="1"){return}o.attr("data-created","1");var j=o.attr("data-locations-id");var i=c("#"+j);var k=c(".sg-map-form",i);var p=c(".sg-geocomplete",k);var q=c("#"+j+"-markers",i);var l=c("#"+j+"-delete").html();var h=new ol.source.Vector({});a(q,h);var m=new ol.style.Style({image:new ol.style.Icon(({anchor:[12,24],anchorXUnits:"pixels",anchorYUnits:"pixels",opacity:0.75,src:urlSegradaBasepath+"img/marker-icon.png"}))});var g=new ol.Map({layers:[new ol.layer.Tile({source:new ol.source.MapQuest({layer:"sat"})}),new ol.layer.Vector({source:h,style:m})],view:new ol.View({center:[0,0],zoom:1}),target:j+"-map"});g.on("singleclick",function(r){g.forEachFeatureAtPixel(r.pixel,function(u,t){var s=new ol.Overlay.Popup();g.addOverlay(s);var v="<p>"+u.get("lat")+","+u.get("lng")+"</p>";v+=u.get("comment");if(u.get("delete_ok").length){v+='<p><a href="'+u.get("delete_url")+'" id="x'+u.get("data_id")+'-delete" data-action="delete">'+l+"</a></p>"}s.show(u.getGeometry().getCoordinates(),v);s.getElement().addEventListener("click",function(x){var w=x.target.getAttribute("data-action");if(w=="delete"){var y=c("#"+j+"-delete-confirm").html().replace("{0}",u.get("lat")+","+u.get("lng"));if(confirm(y)){c.get(u.get("delete_url"),function(z){q.replaceWith(z);q=c("#"+j+"-markers",i);a(q,h)});s.hide()}x.preventDefault()}},false)})});g.on("dblclick",function(r){var t=c(".sg-location-dbl-click",i);if(t.length>0){var s=t.attr("data-confirm").replace("{0}",w[1]+","+w[0]);var w=ol.proj.transform(r.coordinate,"EPSG:3857","EPSG:4326");if(confirm(s)){var v=k.attr("action");var u=c("input[name=_csrf]").val();c.post(v,{_csrf:u,lng:w[0],lat:w[1],comment:""},function(y,z,x){q.replaceWith(y);q=c("#"+j+"-markers",i);a(q,h)});r.preventDefault()}}});c(".sg-map-add-marker",i).click(function(r){c(this).parent().hide();k.show();r.preventDefault()});p.typeahead({hint:true,highlight:true,minLength:3},{name:"address-suggest-"+j,displayKey:"title",valueKey:"id",source:e.ttAdapter()}).bind("typeahead:selected",function(s,r){p.val(r.title);c("input[name=lat]",k).val(r.lat);c("input[name=lng]",k).val(r.lng);c("input[type=submit]",k).show()}).bind("keyup",function(){if(!this.value){p.val("");c("input[name=lat]",k).val("");c("input[name=lng]",k).val("");c("input[type=submit]",k).hide()}});k.ajaxForm({beforeSubmit:function(r,s,t){i.addClass("disabled");return true},success:function(s,t,u,r){i.removeClass("disabled");q.replaceWith(s);q=c("#"+j+"-markers",i);a(q,h);p.val("");c("input[name=lat]",k).val("");c("input[name=lng]",k).val("");c("input[type=submit]",k).hide()},error:function(s,t,u,r){i.removeClass("disabled");alert("Error "+s.status+"\n"+s.statusText)}})})}c(document).ready(function(){afterAjaxHooks.push(b)})})(jQuery);ol.Overlay.Popup=function(c){var a=c||{};this.panMapIfOutOfView=a.panMapIfOutOfView;if(this.panMapIfOutOfView===undefined){this.panMapIfOutOfView=true}this.ani=a.ani;if(this.ani===undefined){this.ani=ol.animation.pan}this.ani_opts=a.ani_opts;if(this.ani_opts===undefined){this.ani_opts={duration:250}}this.container=document.createElement("div");this.container.className="ol-popup";this.closer=document.createElement("a");this.closer.className="ol-popup-closer";this.closer.href="#";this.container.appendChild(this.closer);var b=this;this.closer.addEventListener("click",function(d){b.container.style.display="none";b.closer.blur();d.preventDefault()},false);this.content=document.createElement("div");this.content.className="ol-popup-content";this.container.appendChild(this.content);ol.Overlay.Popup.enableTouchScroll_(this.content);ol.Overlay.call(this,{element:this.container,stopEvent:true,insertFirst:(a.hasOwnProperty("insertFirst"))?a.insertFirst:true})};ol.inherits(ol.Overlay.Popup,ol.Overlay);ol.Overlay.Popup.prototype.show=function(b,a){this.setPosition(b);this.content.innerHTML=a;this.container.style.display="block";if(this.panMapIfOutOfView){this.panIntoView_(b)}this.content.scrollTop=0;return this};ol.Overlay.Popup.prototype.panIntoView_=function(h){var d={width:this.getElement().clientWidth+20,height:this.getElement().clientHeight+20},g=this.getMap().getSize();var e=20,i=60,c=d.width-i,n=this.getOffset(),k=this.getMap().getPixelFromCoordinate(h);var l=(k[0]-i),b=g[0]-(k[0]+c);var o=k[1]-d.height+n[1],f=g[1]-(k[1]+e)-n[1];var a=this.getMap().getView().getCenter(),j=this.getMap().getPixelFromCoordinate(a),m=j.slice();if(b<0){m[0]-=b}else{if(l<0){m[0]+=l}}if(o<0){m[1]+=o}else{if(f<0){m[1]-=f}}if(this.ani&&this.ani_opts){this.ani_opts.source=a;this.getMap().beforeRender(this.ani(this.ani_opts))}if(m[0]!==j[0]||m[1]!==j[1]){this.getMap().getView().setCenter(this.getMap().getCoordinateFromPixel(m))}return this.getMap().getView().getCenter()};ol.Overlay.Popup.isTouchDevice_=function(){try{document.createEvent("TouchEvent");return true}catch(a){return false}};ol.Overlay.Popup.enableTouchScroll_=function(b){if(ol.Overlay.Popup.isTouchDevice_()){var a=0;b.addEventListener("touchstart",function(c){a=this.scrollTop+c.touches[0].pageY},false);b.addEventListener("touchmove",function(c){this.scrollTop=a-c.touches[0].pageY},false)}};ol.Overlay.Popup.prototype.hide=function(){this.container.style.display="none";return this};