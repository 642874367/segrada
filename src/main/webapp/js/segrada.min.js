function escapeHTML(a){if(typeof a=="string"){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}return""}(function(d){var i=new Bloodhound({datumTokenizer:function(v){return Bloodhound.tokenizers.whitespace(v.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaTagSearch+"%QUERY"}});var k=new Bloodhound({datumTokenizer:function(v){return Bloodhound.tokenizers.whitespace(v.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:urlSegradaNodeSearch,replace:function(w,x){var y=w+x;var v=d(".sg-node-search").filter(":focus");var A=d("#"+v.attr("data-select-id")+" option").filter(":selected");var z=A.attr(v.attr("data-attr"));if(z!=null&&z.length>0){y+="&tags="+encodeURIComponent(z)}return y}}});var n=new Bloodhound({datumTokenizer:function(v){return Bloodhound.tokenizers.whitespace(v.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaFileSearch+"%QUERY"}});var u=new Bloodhound({datumTokenizer:function(v){return Bloodhound.tokenizers.whitespace(v.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaSourceSearch+"%QUERY"}});function p(v){return v.replace(/;jsessionid=([^?]*)/,"")}urlSegradaPictogramSearch=p(urlSegradaPictogramSearch);urlSegradaPictogramFile=p(urlSegradaPictogramFile);urlSegradaTagSearch=p(urlSegradaTagSearch);urlSegradaNodeSearch=p(urlSegradaNodeSearch);urlSegradaFileSearch=p(urlSegradaFileSearch);urlSegradaSourceSearch=p(urlSegradaSourceSearch);urlSegradaRelationAdd=p(urlSegradaRelationAdd);var j=false;var g=new vis.DataSet([]);var r=new vis.DataSet([]);var a=null;var s=null;var b=null;d.fn.onEnter=function(v){this.bind("keypress",function(w){if(w.keyCode==13){v.apply(this,[w])}});return this};var l=new RegExp(/<([^\s]+).*?id="([^"]*?)".*?>/i);function f(A,z,y,v,x){var w=urlSegradaPictogramSearch+encodeURIComponent(x);d.getJSON(w,function(C){var B=[];d.each(C,function(D,E){var F=d("<div/>").text(E.title).html();B.push('<div class="col-xs-1 sg-no-padding-right"><a class="sg-pictogram-modal-link" href="#" data-id="'+E.id+'" data-uid="'+E.uid+'" title="'+F+'"><img src="'+urlSegradaPictogramFile+E.uid+'" width="24" height="24" alt="'+F+'" /></a></div>')});z.html("<div class='row'>"+B.join("")+"</div>");d("a",z).click(function(G){var F=d(this).attr("data-id");var E=d(this).attr("data-uid");var D=d("<div/>").text(d(this).attr("title")).html();d("#value-"+y,v).val(F);d("#preview-"+y,v).html('<img src="'+urlSegradaPictogramFile+E+'" width="24" height="24" alt="'+D+'" /> '+D);d("#clear-"+y,v).show();G.preventDefault();A.modal("hide")})}).fail(function(){alert("ERROR")})}function m(v){d.get(v,function(z){var y=z.match(l);if(y!=null&&y.length>=2){d("#"+y[2]).remove()}var x=d("#sg-data");x.prepend(z);var w=x.children(":first");o(w);d("html, body").animate({scrollTop:w.offset().top},500)}).fail(function(){alert("ERROR")})}function o(v){v=v||d("body");d(".sg-data").addClass("sg-dynamic-data");d(".sg-headbox-right").show();d(".sg-dynamic-hide").hide();d(".sg-data-add",v).click(function(x){m(d(this).attr("href"));x.preventDefault()});d(".sg-control-form",v).ajaxForm({beforeSubmit:function(x,z,A){var B=z.attr("data-target-id");if(typeof B=="undefined"||B==null||B.length==0){B="#sg-control";h()}var y=d(B);y.wrapInner("<div class='sg-disabled'></div>");y.prepend(d("#sg-wait").html());return true},success:function(z,B,C,y){var A=y.attr("data-target-id");if(typeof A=="undefined"||A==null||A.length==0){A="#sg-control"}var x=d(A);x.html(z);o(x)},error:function(z,B,C,y){var A=y.attr("data-target-id");if(typeof A=="undefined"||A==null||A.length==0){A="#sg-control"}var x=d(A);x.html(z.statusText);alert("Error "+z.status+"\n"+z.statusText)}});d(".sg-submit-form",v).change(function(){d(this).closest("form").submit()});d(".sg-control-set",v).click(function(A){var z=d(this);var y=z.attr("data-target-id");if(typeof y=="undefined"||y==null||y.length==0){y="#sg-control";h()}var x=d(y);x.wrapInner("<div class='sg-disabled'></div>");x.prepend(d("#sg-wait").html());d.get(z.attr("href"),function(B){x.html(B);o(x)}).fail(function(){alert("ERROR")});A.preventDefault()});d("[data-data-dblclick]",v).dblclick(function(){d.get(d(this).attr("data-data-dblclick"),function(A){var z=A.match(l);if(z!=null&&z.length>=2){d("#"+z[2]).remove()}var y=d("#sg-data");y.prepend(A);var x=y.children(":first");o(x);d("html, body").animate({scrollTop:x.offset().top},500)}).fail(function(){alert("ERROR")})});d("tr [data-confirm]",v).click(function(y){var x=d(this);if(confirm(x.attr("data-confirm"))){var z=x.closest("tr");z.addClass("sg-disabled");d.get(x.attr("href"),function(A){z.slideUp("fast",function(){z.remove()})}).fail(function(){alert("ERROR")})}y.preventDefault()});d(".sg-control-confirm",v).click(function(z){var y=d(this);if(confirm(y.attr("data-confirm"))){var x=d("#"+y.attr("data-target"));x.addClass("sg-disabled");d.get(y.attr("href"),function(A){x.fadeOut("slow",function(){x.remove()})}).fail(function(){alert("ERROR")})}z.preventDefault()});d(".sg-replace-content",v).on("shown.bs.tab",function(z){var y=d(d(this).attr("href"));var x=d(this).attr("data-url");d.get(x,function(A){y.html(A);o(y)}).fail(function(){alert("ERROR")});d(this).removeClass("sg-replace-content");d(this).unbind("shown.bs.tab")});d(".sg-data-close",v).click(function(x){d(this).parent().parent().fadeOut("fast",function(){d(this).remove()})});d("input.sg-fileupload",v).fileinput({showUpload:false});d("input.sg-fileupload-small",v).fileinput({showUpload:false,previewSettings:{image:{width:"auto",height:"24px"}}});d(".sg-pictogram-modal",v).on("shown.bs.modal",function(){var A=d(this);var z=A.attr("id");var y=d("#container-"+z,A);var x=d("#filter-"+z,A);x.on("input propertychange paste",function(){f(A,y,z,v,d(this).val())}).onEnter(function(){var C=d(".sg-pictogram-modal-link",y).first();if(C.length>0){var E=C.attr("data-id");var D=C.attr("data-id");var B=d("<div/>").text(C.attr("title")).html();d("#value-"+z,v).val(E);d("#preview-"+z,v).html('<img src="'+urlSegradaPictogramFile+D+'" width="24" height="24" alt="'+B+'" /> '+B);d("#clear-"+z,v).show();A.modal("hide")}});if(x.val()===""){f(A,y,z,v,"")}});d(".sg-pictogram-chooser",v).click(function(x){d("#"+d(this).attr("data-id")).modal("show");x.preventDefault()});d(".sg-pictogram-clearer",v).click(function(y){var x=d(this).attr("data-id");d("#value-"+x,v).val("");d("#preview-"+x,v).html("");d(this).hide();y.preventDefault()});d(".sg-source-ref-modal",v).on("shown.bs.modal",function(){var z=d(this);var y=z.attr("id");var x=d(".modal-body",z);d.get(z.attr("data-href"),function(A){x.html(A);d("form",x).ajaxForm({beforeSubmit:function(B,C,D){C.wrapInner("<div class='sg-disabled'></div>");C.prepend(d("#sg-wait").html());return true},success:function(C,E,F,B){var D=d(z.attr("data-target"));D.html(C);o(D);z.modal("hide")},error:function(C,D,E,B){alert("Error "+C.status+"\n"+C.statusText)}})}).fail(function(){alert("ERROR")})}).on("hidden.bs.modal",function(){d(".modal-body",d(this)).html(d("#sg-wait").html())});d(".sg-source-ref-editor",v).click(function(y){var x=d("#"+d(this).attr("data-id"));x.attr("data-href",d(this).attr("href"));x.modal("show");y.preventDefault()});d(".sg-taglist-contract",v).each(function(){var x=d("span",d(this));if(x.length>1){x.hide().filter(":first-child").show().after('<span class="sg-tag-show label label-default"><i class="fa fa-plus"></i></span>');d("span.sg-tag-show",d(this)).click(function(){d(this).remove();x.show()})}});d("select.sg-colorpicker",v).simplepicker({theme:"fontawesome"});d("select.sg-tags",v).each(function(){var x=d(this);x.tagsinput({trimValue:true,confirmKeys:[13],typeaheadjs:{name:"tags",displayKey:"title",valueKey:"title",source:i.ttAdapter()}});x.on("itemRemoved",function(y){x.find('option[value="'+y.item+'"]').remove()})});d("input.sg-node-search",v).each(function(){var y=d(this);var x=d("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"node",displayKey:"title",valueKey:"id",source:k.ttAdapter()}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});d("input.sg-file-search",v).each(function(){var y=d(this);var x=d("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"file",displayKey:"title",valueKey:"id",source:n.ttAdapter()}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});d("input.sg-source-search",v).each(function(){var y=d(this);var x=d("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"source",displayKey:"title",valueKey:"id",source:u.ttAdapter()}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});d(".sg-link-external",v).click(function(z){var x=d(this).attr("href");var y=window.open(x,"_blank");y.focus();z.preventDefault()});d("form.sg-data-form",v).ajaxForm({beforeSubmit:function(x,y,z){d(":input",y).attr("disabled",true);d("button.btn-primary",y).append(" "+d("#sg-wait-btn").html());return true},success:function(z,B,C,x){var A=x.attr("data-id");if(typeof A!=="undefined"){A=d("#"+A)}A=A||x;A.replaceWith(z);var y=z.match(l);if(y!=null&&y.length>=2){o(d("#"+y[2]))}},error:function(y,z,A,x){d(":input",x).attr("disabled",false);alert("Error "+y.status+"\n"+y.statusText)}});d("form.sg-simple-form",v).ajaxForm({beforeSubmit:function(x,y,z){d(":input",y).attr("disabled",true);var A=y.attr("data-id");if(typeof A!=="undefined"){A=d("#"+A)}A=A||y;A.html(d("#sg-wait"));return true},success:function(y,A,B,x){var z=x.attr("data-id");if(typeof z!=="undefined"){z=d("#"+z)}z=z||x;z.html(y);d(":input",x).attr("disabled",false)},error:function(y,z,A,x){d(":input",x).attr("disabled",false);alert("Error "+y.status+"\n"+y.statusText)}});d(".sg-periods").each(function(){var x=d(this);var z=x.attr("id");var y=d(".sg-period-form",x);d(".sg-period-add",x).click(function(B){d(this).hide();var A=d(".sg-period-form-add",x);A.show();d(".sg-period-form-period",A).change(function(C){if(d(this).is(":checked")){d(".sg-period-toggle",A).show()}else{d(".sg-period-toggle",A).hide()}});B.preventDefault()});y.ajaxForm({beforeSubmit:function(A,B,C){x.addClass("disabled");return true},success:function(B,C,D,A){x.replaceWith(B);o(d("#"+z))},error:function(B,C,D,A){x.removeClass("disabled");alert("Error "+B.status+"\n"+B.statusText)}})});d(".sg-ajax-modal",v).click(function(A){var y=d("#sg-modal");var x=d(".modal-body-inner",y);var z=d(".modal-loading",y);d("h4",y).html(d(this).attr("data-title"));x.html("");x.hide();z.show();y.modal("show");d.get(d(this).attr("href"),function(B){z.hide();x.html(B);x.show();o(x)}).fail(function(){alert("ERROR")});A.preventDefault()});d(".sg-ajax-modal-form",v).ajaxForm({beforeSubmit:function(x,y,B){var A=d("#sg-modal");var z=d(".modal-body-inner",A);var C=d(".modal-loading",A);z.hide();C.show();return true},success:function(B,C,D,x){var z=d("#sg-modal");var y=d(".modal-body-inner",z);var A=d(".modal-loading",z);y.html(B);y.show();A.hide();o(y);z=d("#sg-modal");d(".sg-update-period",z).each(function(){var F=d(this).attr("data-id");var G=d(F);if(G.length>0){for(var E=0;E<3;E++){d("td:eq("+E+")",G).html(d("div:eq("+E+")",d(this)).html())}}})},error:function(B,C,D,x){var z=d("#sg-modal");var y=d(".modal-body-inner",z);var A=d(".modal-loading",z);y.html(B);y.show();A.hide();o(y)}});d("a.sg-graph-update",v).click(function(x){t(d(this).attr("href"));x.preventDefault()});d("div.sg-tag-hierarchy",v).each(function(){var C=d(this);var x=d(".sg-tag-hierarchy-graph",C);d(".sg-child-tags",C).hide();x.addClass("sg-margin-top sg-margin-bottom");var D=d(".sg-tag-hierarchy-data",C);var z=D.attr("data-center");var G=0;var F=0;var y=[];var B=[];d("div",D).each(function(){var L=d(this);var J=L.attr("data-id");var K=L.attr("data-level");y.push({id:J,label:L.html(),level:K,url:L.attr("data-url")});if(K=="0"){B.push({from:J,to:z});G++}else{if(K=="2"){B.push({from:z,to:J});F++}}});var E=G>F?(G==0?1:G):F;x.css({width:"100%",height:(E*50)+"px",border:"1px solid #ccc"});var A={nodes:new vis.DataSet(y),edges:new vis.DataSet(B)};y=null;B=null;var I={edges:{smooth:{type:"cubicBezier",forceDirection:"horizontal",roundness:0.6}},nodes:{shape:"box"},layout:{hierarchical:{direction:"LR"}}};var H=new vis.Network(x.get(0),A,I);H.on("doubleClick",function(L){var J=null;if(L.nodes.length>0){var K=A.nodes.get(L.nodes[0]);if(K!=null&&K.url!=null){J=K.url}}if(J!=null){m(J)}})});for(var w=0;w<afterAjaxHooks.length;w++){afterAjaxHooks[w](v)}}function c(){if(!j){j=true;var v=document.getElementById("sg-graph");var x={nodes:g,edges:r};var w={locale:d("html").attr("lang"),locales:{de:{edit:"Änderungsmodus",del:"Lösche Auswahl",back:"Zurück",addNode:"Knoten hinzufügen",addEdge:"Verknüpfung hinzufügen",editNode:"Knoten editieren",editEdge:"Verknüpfung editieren",addDescription:"Klicke auf eine freie Stelle, um einen neuen Knoten zu plazieren.",edgeDescription:"Klicke auf einen Knoten und ziehe die Verknüpfung zu einem anderen Knoten, um diese zu verbinden.",editEdgeDescription:"Klicke auf die Verbindungspunkte und ziehe diese auf einen Knoten, um sie zu verbinden.",createEdgeError:"Es ist nicht möglich, Verknüpfungen mit Clustern zu verbinden.",deleteClusterError:"Cluster können nicht gelöscht werden.",editClusterError:"Cluster können nicht editiert werden."},en:{edit:"Toggle edit",del:"Delete selected",back:"Back",addNode:"Add Node",addEdge:"Add Relation",editNode:"Edit Node",editEdge:"Edit Relation",addDescription:"Click in an empty space to place a new node.",edgeDescription:"Click on a node and drag the relation to another node to connect them.",editEdgeDescription:"Click on the control points and drag them to a node to connect to it.",createEdgeError:"Cannot link relations to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."}},manipulation:{enabled:true,addNode:false,addEdge:function(z,A){var y=urlSegradaRelationAdd.replace("XFROMX",z.from.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("XTOX",z.to.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("&amp;","&");m(y);return false},editNode:function(y,z){return false},editEdge:function(y,z){return false},deleteNode:function(y,z){return false},deleteEdge:function(y,z){return false}},nodes:{shape:"icon",color:{border:"#000",background:"#fff"}},edges:{font:{size:10},labelHighlightBold:false,selectionWidth:0,arrows:{to:true},smooth:{type:"cubicBezier"}},groups:{node:{icon:{code:"\uf192",color:"#000000"}},tag:{shape:"box",color:{border:"#5bc0de",background:"#5bc0de",highlight:{background:"#2B7CE9"}},font:{color:"#ffffff",size:12}}},physics:{barnesHut:{springLength:120}}};a=new vis.Network(v,x,w);a.on("doubleClick",function(B){var y=null;if(B.nodes.length>0){var A=g.get(B.nodes[0]);if(A!=null&&A.url!=null){y=A.url}}else{if(B.edges.length>0){var z=r.get(B.edges[0]);if(z!=null&&z.url!=null){y=z.url}}}if(y!=null){m(y)}})}}function h(){var v=d("#sg-toggle-graph");if(v.hasClass("active")){v.removeClass("active");d(".fa-share-alt-square",v).addClass("fa-share-alt").removeClass("fa-share-alt-square");a.storePositions();d("#sg-graph-container").hide();d("#sg-control").show();a.destroy();j=false}}function q(){var v=d("#sg-toggle-graph");if(!v.hasClass("active")){v.addClass("active");d(".fa-share-alt",v).addClass("fa-share-alt-square").removeClass("fa-share-alt");d("#sg-control").hide();d("#sg-graph-container").show();c()}}function t(w){if(w==null){alert("Null url!");return}q();var y=[];var A=[];var v=g.get({fields:["id"]});for(var x=0;x<v.length;x++){y.push(v[x].id)}v=r.get({fields:["id"]});for(var x=0;x<v.length;x++){A.push(v[x].id)}var z=d("#sg-graph-container").attr("data-csrf");d.ajax({url:w,type:"POST",dataType:"json",headers:{"Content-Type":"application/json","X-CSRF-Token":z},data:JSON.stringify({nodes:y,edges:A}),success:function(C,D,B){if(C==null){alert("NULL data");return}if(C.error!=null){alert(C.error);return}if(C.nodes!=null&&C.nodes.length>0){g.update(C.nodes)}if(C.edges!=null&&C.edges.length>0){r.update(C.edges)}if(C.removeNodes!=null&&C.removeNodes.length>0){g.remove(C.removeNodes)}if(C.removeEdges!=null&&C.removeEdges.length>0){r.remove(C.removeEdges)}if(C.highlightNode!=null){a.unselectAll();a.selectNodes([C.highlightNode],false)}a.fit()}})}function e(){r.clear();g.clear();b="";s=""}d.event.special.destroyed={remove:function(v){if(v.handler){v.handler()}}};d(document).ready(function(){d("#sg-close-all").click(function(v){d(".sg-data").fadeOut("fast",function(){d(this).remove()});v.preventDefault()});d(".sg-locale").click(function(v){d.get(d(this).attr("href"),function(x){var w=d("#sg-base").html();if(x!=""){window.location.href=w}}).fail(function(){alert("ERROR")});v.preventDefault()});i.initialize();d("#sg-toggle-graph").click(function(v){if(d(this).hasClass("active")){h()}else{q()}v.preventDefault()});d("#sg-graph-action-remove").click(function(w){var v=a.getSelection();if(v.edges.length>0){r.remove(v.edges)}if(v.nodes.length>0){g.remove(v.nodes)}w.preventDefault()});d("#sg-graph-action-restart").click(function(v){e();v.preventDefault()});d("#sg-graph-action-reload").click(function(v){a.destroy();j=false;c();v.preventDefault()});d("#sg-graph-action-fit").click(function(v){a.fit();v.preventDefault()});d("#sg-graph-close").click(function(v){h();v.preventDefault()});d("#sg-graph-action-load").click(function(v){d("#sg-graph-modal-load").modal();v.preventDefault()});d("#sg-graph-action-save").click(function(w){if(g.length>0){d("#title-sg-graph-save").val(s!=null?s:"");var v=d("#save-as-new-sg-graph-save").parent().parent().parent();if(b!=null){v.show()}else{v.hide()}d("#sg-graph-modal-save").modal()}w.preventDefault()});d("#sg-graph-modal-load").on("shown.bs.modal",function(){var x=d(this);var w=d(".modal-body",x);w.html(d("#sg-wait").html());var v=x.attr("data-url");d.get(v,function(A){var y=x.attr("data-get-url");var z="";A.forEach(function(B){z+="<li><a href='"+y+B.uid+"' data-uid='"+B.uid+"'>"+B.title+"</a></li>"});if(z!=""){z="<ul>"+z+"</ul>"}w.html(z);d("a",w).click(function(B){e();t(d(this).attr("href"));s=d(this).html();b=d(this).attr("data-uid");x.modal("hide");B.preventDefault()})})});d("#sg-graph-modal-save-frm").submit(function(z){z.preventDefault();var A=d("#title-sg-graph-save").val();var x=b;if(b!=null&&d("#save-as-new-sg-graph-save").is(":checked")){x=null}a.storePositions();var w=[];var v=[];g.forEach(function(B){w.push({id:B.id,x:B.x,y:B.y,group:B.group})});r.forEach(function(B){v.push({id:B.id,group:B.group})});var y={};d.post(d(this).attr("action"),{_csrf:d("#sg-graph-container").attr("data-csrf"),uid:x,title:A,type:"graph",data:JSON.stringify({nodes:w,edges:v})},function(B){s=A;b=B}).fail(function(){alert("ERROR")});d("#sg-graph-modal-save").modal("hide")});o(d("body"))})})(jQuery);