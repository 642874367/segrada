(function(c){function n(w){if(typeof w=="string"){return w.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}return""}var g=new Bloodhound({datumTokenizer:function(w){return Bloodhound.tokenizers.whitespace(w.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaTagSearch+"%QUERY"}});var h=new Bloodhound({datumTokenizer:function(w){return Bloodhound.tokenizers.whitespace(w.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:urlSegradaNodeSearch,replace:function(x,y){var z=x+y;var w=c(".sg-node-search").filter(":focus");var B=c("#"+w.attr("data-select-id")+" option").filter(":selected");var A=B.attr(w.attr("data-attr"));if(A!=null&&A.length>0){z+="&tags="+encodeURIComponent(A)}return z}}});var l=new Bloodhound({datumTokenizer:function(w){return Bloodhound.tokenizers.whitespace(w.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaFileSearch+"%QUERY"}});var v=new Bloodhound({datumTokenizer:function(w){return Bloodhound.tokenizers.whitespace(w.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaSourceSearch+"%QUERY"}});function p(w){return w.replace(/;jsessionid=([^?]*)/,"")}urlSegradaPictogramSearch=p(urlSegradaPictogramSearch);urlSegradaPictogramFile=p(urlSegradaPictogramFile);urlSegradaTagSearch=p(urlSegradaTagSearch);urlSegradaNodeSearch=p(urlSegradaNodeSearch);urlSegradaFileSearch=p(urlSegradaFileSearch);urlSegradaSourceSearch=p(urlSegradaSourceSearch);urlSegradaRelationAdd=p(urlSegradaRelationAdd);var o=false;window.gMapsCallback=function(){o=true};window.loadGoogleMaps=function(){if(o){return window.gMapsCallback()}var w=document.createElement("script");w.setAttribute("type","text/javascript");w.setAttribute("src","http://maps.google.com/maps/api/js?sensor=false&callback=gMapsCallback&libraries=places&language="+c("html").attr("lang"));(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(w)};var i=false;var e=new vis.DataSet([]);var s=new vis.DataSet([]);var a=null;c.fn.onEnter=function(w){this.bind("keypress",function(x){if(x.keyCode==13){w.apply(this,[x])}});return this};var j=new RegExp(/<([^\s]+).*?id="([^"]*?)".*?>/i);function d(B,A,z,w,y){var x=urlSegradaPictogramSearch+encodeURIComponent(y);c.getJSON(x,function(D){var C=[];c.each(D,function(E,F){var G=c("<div/>").text(F.title).html();C.push('<div class="col-xs-1 sg-no-padding-right"><a class="sg-pictogram-modal-link" href="#" data-id="'+F.id+'" data-uid="'+F.uid+'" title="'+G+'"><img src="'+urlSegradaPictogramFile+F.uid+'" width="24" height="24" alt="'+G+'" /></a></div>')});A.html("<div class='row'>"+C.join("")+"</div>");c("a",A).click(function(H){var G=c(this).attr("data-id");var F=c(this).attr("data-uid");var E=c("<div/>").text(c(this).attr("title")).html();c("#value-"+z,w).val(G);c("#preview-"+z,w).html('<img src="'+urlSegradaPictogramFile+F+'" width="24" height="24" alt="'+E+'" /> '+E);c("#clear-"+z,w).show();H.preventDefault();B.modal("hide")})})}function k(w){c.get(w,function(A){var z=A.match(j);if(z!=null&&z.length>=2){c("#"+z[2]).remove()}var y=c("#sg-data");y.prepend(A);var x=y.children(":first");m(x);c("html, body").animate({scrollTop:x.offset().top},500)})}function m(w){w=w||c("body");c(".sg-data").addClass("sg-dynamic-data");c(".sg-headbox-right").show();c(".sg-dynamic-hide").hide();c(".sg-data-add",w).click(function(x){k(c(this).attr("href"));x.preventDefault()});c(".sg-control-form",w).ajaxForm({beforeSubmit:function(x,z,A){var B=z.attr("data-target-id");if(typeof B=="undefined"||B==null||B.length==0){B="#sg-control";f()}var y=c(B);y.wrapInner("<div class='sg-disabled'></div>");y.prepend(c("#sg-wait").html());return true},success:function(z,B,C,y){var A=y.attr("data-target-id");if(typeof A=="undefined"||A==null||A.length==0){A="#sg-control"}var x=c(A);x.html(z);m(x)},error:function(z,B,C,y){var A=y.attr("data-target-id");if(typeof A=="undefined"||A==null||A.length==0){A="#sg-control"}var x=c(A);x.html(z.statusText);alert("Error "+z.status+"\n"+z.statusText)}});c(".sg-submit-form",w).change(function(){c(this).closest("form").submit()});c(".sg-control-set",w).click(function(A){var z=c(this);var y=z.attr("data-target-id");if(typeof y=="undefined"||y==null||y.length==0){y="#sg-control";f()}var x=c(y);x.wrapInner("<div class='sg-disabled'></div>");x.prepend(c("#sg-wait").html());c.get(z.attr("href"),function(B){x.html(B);m(x)});A.preventDefault()});c("[data-data-dblclick]",w).dblclick(function(){c.get(c(this).attr("data-data-dblclick"),function(A){var z=A.match(j);if(z!=null&&z.length>=2){c("#"+z[2]).remove()}var y=c("#sg-data");y.prepend(A);var x=y.children(":first");m(x);c("html, body").animate({scrollTop:x.offset().top},500)})});c("tr [data-confirm]",w).click(function(y){var x=c(this);if(confirm(x.attr("data-confirm"))){var z=x.closest("tr");z.addClass("sg-disabled");c.get(x.attr("href"),function(A){z.slideUp("fast",function(){z.remove()})})}y.preventDefault()});c(".sg-replace-content",w).on("shown.bs.tab",function(z){var y=c(c(this).attr("href"));var x=c(this).attr("data-url");c.get(x,function(A){y.html(A);m(y)});c(this).removeClass("sg-replace-content");c(this).unbind("shown.bs.tab")});c(".sg-data-close",w).click(function(x){c(this).parent().parent().fadeOut("fast",function(){c(this).remove()})});c("input.sg-fileupload",w).fileinput({showUpload:false});c("input.sg-fileupload-small",w).fileinput({showUpload:false,previewSettings:{image:{width:"auto",height:"24px"}}});c(".sg-pictogram-modal").on("shown.bs.modal",function(){var A=c(this);var z=A.attr("id");var y=c("#container-"+z,A);var x=c("#filter-"+z,A);x.on("input propertychange paste",function(){d(A,y,z,w,c(this).val())}).onEnter(function(){var C=c(".sg-pictogram-modal-link",y).first();if(C.length>0){var E=C.attr("data-id");var D=C.attr("data-id");var B=c("<div/>").text(C.attr("title")).html();c("#value-"+z,w).val(E);c("#preview-"+z,w).html('<img src="'+urlSegradaPictogramFile+D+'" width="24" height="24" alt="'+B+'" /> '+B);c("#clear-"+z,w).show();A.modal("hide")}});if(x.val()===""){d(A,y,z,w,"")}});c(".sg-pictogram-chooser",w).click(function(x){c("#"+c(this).attr("data-id")).modal("show");x.preventDefault()});c(".sg-pictogram-clearer",w).click(function(y){var x=c(this).attr("data-id");c("#value-"+x,w).val("");c("#preview-"+x,w).html("");c(this).hide();y.preventDefault()});c(".sg-source-ref-modal").on("shown.bs.modal",function(){var z=c(this);var y=z.attr("id");var x=c(".modal-body",z);c.get(z.attr("data-href"),function(A){x.html(A);c("form",x).ajaxForm({beforeSubmit:function(B,C,D){C.wrapInner("<div class='sg-disabled'></div>");C.prepend(c("#sg-wait").html());return true},success:function(C,E,F,B){var D=c(z.attr("data-target"));D.html(C);m(D);z.modal("hide")},error:function(C,D,E,B){alert("Error "+C.status+"\n"+C.statusText)}})})}).on("hidden.bs.modal",function(){c(".modal-body",c(this)).html(c("#sg-wait").html())});c(".sg-source-ref-editor",w).click(function(y){var x=c("#"+c(this).attr("data-id"));x.attr("data-href",c(this).attr("href"));x.modal("show");y.preventDefault()});c(".sg-taglist-contract",w).each(function(){var x=c("span",c(this));if(x.length>1){x.hide().filter(":first-child").show().after('<span class="sg-tag-show label label-default"><i class="fa fa-plus"></i></span>');c("span.sg-tag-show",c(this)).click(function(){c(this).remove();x.show()})}});c("select.sg-colorpicker",w).simplepicker({theme:"fontawesome"});c("select.sg-tags",w).each(function(){var x=c(this);x.tagsinput({trimValue:true,confirmKeys:[13],typeaheadjs:{name:"tags",displayKey:"title",valueKey:"title",source:g.ttAdapter()}});x.on("itemRemoved",function(y){x.find('option[value="'+y.item+'"]').remove()})});c("input.sg-node-search",w).each(function(){var y=c(this);var x=c("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"node",displayKey:"title",valueKey:"id",source:h.ttAdapter()}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});c("input.sg-file-search",w).each(function(){var y=c(this);var x=c("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"file",displayKey:"title",valueKey:"id",source:l.ttAdapter()}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});c("input.sg-source-search",w).each(function(){var y=c(this);var x=c("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"source",displayKey:"title",valueKey:"id",source:v.ttAdapter()}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});c(".sg-link-external",w).click(function(z){var x=c(this).attr("href");var y=window.open(x,"_blank");y.focus();z.preventDefault()});c("form.sg-data-form",w).ajaxForm({beforeSubmit:function(x,y,z){c(":input",y).attr("disabled",true);return true},success:function(z,B,C,x){var A=x.attr("data-id");if(typeof A!=="undefined"){A=c("#"+A)}A=A||x;A.replaceWith(z);var y=z.match(j);if(y!=null&&y.length>=2){m(c("#"+y[2]))}},error:function(y,z,A,x){c(":input",x).attr("disabled",false);alert("Error "+y.status+"\n"+y.statusText)}});c("form.sg-simple-form",w).ajaxForm({beforeSubmit:function(x,y,z){c(":input",y).attr("disabled",true);var A=y.attr("data-id");if(typeof A!=="undefined"){A=c("#"+A)}A=A||y;A.html(c("#sg-wait"));return true},success:function(y,A,B,x){var z=x.attr("data-id");if(typeof z!=="undefined"){z=c("#"+z)}z=z||x;z.html(y);c(":input",x).attr("disabled",false)},error:function(y,z,A,x){c(":input",x).attr("disabled",false);alert("Error "+y.status+"\n"+y.statusText)}});c(".sg-periods").each(function(){var x=c(this);var z=x.attr("id");var y=c(".sg-period-form",x);c(".sg-period-add",x).click(function(B){c(this).hide();var A=c(".sg-period-form-add",x);A.show();c(".sg-period-form-period",A).change(function(C){if(c(this).is(":checked")){c(".sg-period-toggle",A).show()}else{c(".sg-period-toggle",A).hide()}});B.preventDefault()});c(".sg-period-edit",x).click(function(A){c(this).hide();c(".sg-period-form-edit",x).show();A.preventDefault()});y.ajaxForm({beforeSubmit:function(A,B,C){x.addClass("disabled");return true},success:function(B,C,D,A){x.replaceWith(B);m(c("#"+z))},error:function(B,C,D,A){x.removeClass("disabled");alert("Error "+B.status+"\n"+B.statusText)}})});c(".sg-geotab",w).on("shown.bs.tab",function(C){var B=c(C.target);if(B.attr("data-created")=="1"){return}B.attr("data-created","1");var D=B.attr("data-locations-id");var y=c(D);var A=c(".sg-map-form",y);var z=c(".sg-geocomplete",A);var x=new google.maps.LatLng(0,0);z.geocomplete({map:D+"-map",details:D+"-form",markerOptions:{draggable:true},mapOptions:{mapTypeId:google.maps.MapTypeId.HYBRID,zoom:1,center:x,scrollwheel:true,draggable:true}}).bind("geocode:result",function(F,E){c("input[type=submit]",A).show()}).bind("geocode:dragged",function(F,E){c("input[name=lat]",A).val(E.lat());c("input[name=lng]",A).val(E.lng())});c(".sg-map-add-marker",y).click(function(E){c(this).hide();A.show();E.preventDefault()});t(D,c(D+"-markers",y),z);c(D+"-map").on("destroyed",function(){if(typeof q[D]!=="undefined"){for(var E=0;E<q[D].length;E++){q[D][E].setMap(null)}delete q[D]}});c(".sg-geocomplete-find",A).click(function(){z.trigger("geocode")}).click();A.ajaxForm({beforeSubmit:function(E,F,G){y.addClass("disabled");return true},success:function(F,G,H,E){y.removeClass("disabled");c(D+"-markers",y).replaceWith(F);t(D,c(D+"-markers",y),z)},error:function(F,G,H,E){y.removeClass("disabled");alert("Error "+F.status+"\n"+F.statusText)}})});c("a.sg-graph-update",w).click(function(x){u(c(this).attr("href"));x.preventDefault()});c("div.sg-tag-hierarchy",w).each(function(){var C=c(this);var x=c(".sg-tag-hierarchy-graph",C);c(".sg-child-tags",C).hide();x.addClass("sg-margin-top sg-margin-bottom");var D=c(".sg-tag-hierarchy-data",C);var z=D.attr("data-center");var G=0;var F=0;var y=[];var B=[];c("div",D).each(function(){var L=c(this);var J=L.attr("data-id");var K=L.attr("data-level");y.push({id:J,label:L.html(),level:K,url:L.attr("data-url")});if(K=="0"){B.push({from:J,to:z});G++}else{if(K=="2"){B.push({from:z,to:J});F++}}});var E=G>F?(G==0?1:G):F;x.css({width:"100%",height:(E*50)+"px",border:"1px solid #ccc"});var A={nodes:new vis.DataSet(y),edges:new vis.DataSet(B)};y=null;B=null;var I={edges:{smooth:{type:"cubicBezier",forceDirection:"horizontal",roundness:0.6}},nodes:{shape:"box"},layout:{hierarchical:{direction:"LR"}}};var H=new vis.Network(x.get(0),A,I);H.on("doubleClick",function(L){var J=null;if(L.nodes.length>0){var K=A.nodes.get(L.nodes[0]);if(K!=null&&K.url!=null){J=K.url}}if(J!=null){k(J)}})})}var q=[];function t(C,x,w){var B=w.geocomplete("map");if(typeof q[C]!=="undefined"){for(var y=0;y<q[C].length;y++){q[C][y].setMap(null)}delete q[C]}q[C]=[];var A=c(C+"-delete").html();var z=new google.maps.LatLngBounds();c(".sg-location-marker",x).each(function(){var H=c(this);var E=new google.maps.LatLng(H.attr("data-lat"),H.attr("data-lng"));z.extend(E);var F=H.attr("data-id");var I=H.attr("data-comment");if(typeof I!="undefined"&&I!=""){I="<p>"+n(I)+"</p>"}else{I=""}var G=new google.maps.InfoWindow({content:"<p>"+H.attr("data-lat")+","+H.attr("data-lng")+"</p>"+I+'<p><a href="'+H.attr("data-delete")+'" id="'+F+'-delete">'+A+"</a></p>"});var D=new google.maps.Marker({position:E,map:B,icon:"https://maps.google.com/mapfiles/ms/micons/blue-dot.png"});google.maps.event.addListener(D,"click",function(){G.open(B,D);var J=c("#"+F+"-delete");J.unbind("click");J.click(function(K){var L=c(C+"-delete-confirm").html().replace("{0}",H.attr("data-lat")+","+H.attr("data-lng"));if(confirm(L)){c.get(c(this).attr("href"),function(M){x.replaceWith(M);t(C,c(C+"-markers"),w)})}K.preventDefault()})});q[C][q[C].length]=D});if(q[C].length==0){B.setZoom(1);B.setCenter(new google.maps.LatLng(0,0))}else{B.fitBounds(z);if(q[C].length==1){setTimeout(function(){B.setZoom(12)},250)}}}function b(){if(!i){i=true;var w=document.getElementById("sg-graph");var y={nodes:e,edges:s};var x={locale:c("html").attr("lang"),locales:{de:{edit:"Änderungsmodus",del:"Lösche Auswahl",back:"Zurück",addNode:"Knoten hinzufügen",addEdge:"Verknüpfung hinzufügen",editNode:"Knoten editieren",editEdge:"Verknüpfung editieren",addDescription:"Klicke auf eine freie Stelle, um einen neuen Knoten zu plazieren.",edgeDescription:"Klicke auf einen Knoten und ziehe die Verknüpfung zu einem anderen Knoten, um diese zu verbinden.",editEdgeDescription:"Klicke auf die Verbindungspunkte und ziehe diese auf einen Knoten, um sie zu verbinden.",createEdgeError:"Es ist nicht möglich, Verknüpfungen mit Clustern zu verbinden.",deleteClusterError:"Cluster können nicht gelöscht werden.",editClusterError:"Cluster können nicht editiert werden."},en:{edit:"Toggle edit",del:"Delete selected",back:"Back",addNode:"Add Node",addEdge:"Add Relation",editNode:"Edit Node",editEdge:"Edit Relation",addDescription:"Click in an empty space to place a new node.",edgeDescription:"Click on a node and drag the relation to another node to connect them.",editEdgeDescription:"Click on the control points and drag them to a node to connect to it.",createEdgeError:"Cannot link relations to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."}},manipulation:{enabled:true,addNode:false,addEdge:function(A,B){var z=urlSegradaRelationAdd.replace("XFROMX",A.from.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("XTOX",A.to.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("&amp;","&");k(z);return false},editNode:function(z,A){return false},editEdge:function(z,A){return false},deleteNode:function(z,A){return false},deleteEdge:function(z,A){return false}},nodes:{shape:"icon",color:{border:"#000",background:"#fff"}},edges:{font:{size:10},labelHighlightBold:false,selectionWidth:0,arrows:{to:true},smooth:{type:"cubicBezier"}},groups:{node:{icon:{code:"\uf192",color:"#000000"}},tag:{shape:"box",color:{border:"#5bc0de",background:"#5bc0de",highlight:{background:"#2B7CE9"}},font:{color:"#ffffff",size:12}}},physics:{barnesHut:{springLength:120}}};a=new vis.Network(w,y,x);a.on("doubleClick",function(C){var z=null;if(C.nodes.length>0){var B=e.get(C.nodes[0]);if(B!=null&&B.url!=null){z=B.url}}else{if(C.edges.length>0){var A=s.get(C.edges[0]);if(A!=null&&A.url!=null){z=A.url}}}if(z!=null){k(z)}})}}function f(){var w=c("#sg-toggle-graph");if(w.hasClass("active")){w.removeClass("active");c(".fa-share-alt-square",w).addClass("fa-share-alt").removeClass("fa-share-alt-square");c("#sg-graph-container").hide();c("#sg-control").show();a.destroy();i=false}}function r(){var w=c("#sg-toggle-graph");if(!w.hasClass("active")){w.addClass("active");c(".fa-share-alt",w).addClass("fa-share-alt-square").removeClass("fa-share-alt");c("#sg-control").hide();c("#sg-graph-container").show();b()}}function u(x){if(x==null){alert("Null url!");return}r();var z=[];var B=[];var w=e.get({fields:["id"]});for(var y=0;y<w.length;y++){z.push(w[y].id)}w=s.get({fields:["id"]});for(var y=0;y<w.length;y++){B.push(w[y].id)}var A=c("#sg-graph-container").attr("data-csrf");c.ajax({url:x,type:"POST",dataType:"json",headers:{"Content-Type":"application/json","X-CSRF-Token":A},data:JSON.stringify({nodes:z,edges:B}),success:function(D,E,C){if(D==null){alert("NULL data");return}if(D.error!=null){alert(D.error);return}if(D.nodes!=null&&D.nodes.length>0){e.update(D.nodes)}if(D.edges!=null&&D.edges.length>0){s.update(D.edges)}if(D.removeNodes!=null&&D.removeNodes.length>0){e.remove(D.removeNodes)}if(D.removeEdges!=null&&D.removeEdges.length>0){s.remove(D.removeEdges)}if(D.highlightNode!=null){a.unselectAll();a.selectNodes([D.highlightNode],false)}a.fit()}})}c.event.special.destroyed={remove:function(w){if(w.handler){w.handler()}}};c(document).ready(function(){c("#sg-close-all").click(function(w){c(".sg-data").fadeOut("fast",function(){c(this).remove()});w.preventDefault()});c(".sg-locale").click(function(w){c.get(c(this).attr("href"),function(y){var x=c("#sg-base").html();if(y!=""){window.location.href=x}});w.preventDefault()});g.initialize();c("#sg-toggle-graph").click(function(w){if(c(this).hasClass("active")){f()}else{r()}w.preventDefault()});c("#sg-graph-action-remove").click(function(x){var w=a.getSelection();if(w.edges.length>0){s.remove(w.edges)}if(w.nodes.length>0){e.remove(w.nodes)}x.preventDefault()});c("#sg-graph-action-restart").click(function(w){s.clear();e.clear();w.preventDefault()});c("#sg-graph-action-reload").click(function(w){a.destroy();i=false;b();w.preventDefault()});c("#sg-graph-action-fit").click(function(w){a.fit();w.preventDefault()});c("#sg-graph-close").click(function(w){f();w.preventDefault()});m(c("body"));window.loadGoogleMaps()})})(jQuery);