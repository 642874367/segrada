function escapeHTML(a){if(typeof a=="string"){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}return""}(function(e){var j=new Bloodhound({datumTokenizer:function(x){return Bloodhound.tokenizers.whitespace(x.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaTagSearch+"%QUERY"}});var l=new Bloodhound({datumTokenizer:function(x){return Bloodhound.tokenizers.whitespace(x.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:urlSegradaNodeSearch,replace:function(y,z){var A=y+z;var x=e(".sg-node-search").filter(":focus");var C=e("#"+x.attr("data-select-id")+" option").filter(":selected");var B=C.attr(x.attr("data-attr"));if(B!=null&&B.length>0){A+="&tags="+encodeURIComponent(B)}return A}}});var o=new Bloodhound({datumTokenizer:function(x){return Bloodhound.tokenizers.whitespace(x.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaFileSearch+"%QUERY"}});var v=new Bloodhound({datumTokenizer:function(x){return Bloodhound.tokenizers.whitespace(x.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaSourceSearch+"%QUERY"}});function q(x){return x.replace(/;jsessionid=([^?]*)/,"")}urlSegradaPictogramSearch=q(urlSegradaPictogramSearch);urlSegradaPictogramFile=q(urlSegradaPictogramFile);urlSegradaTagSearch=q(urlSegradaTagSearch);urlSegradaNodeSearch=q(urlSegradaNodeSearch);urlSegradaFileSearch=q(urlSegradaFileSearch);urlSegradaSourceSearch=q(urlSegradaSourceSearch);urlSegradaRelationAdd=q(urlSegradaRelationAdd);var k=false;var h=new vis.DataSet([]);var s=new vis.DataSet([]);var b=null;var t=null;var c=null;e.fn.onEnter=function(x){this.bind("keypress",function(y){if(y.keyCode==13){x.apply(this,[y])}});return this};var m=new RegExp(/<([^\s]+).*?id="([^"]*?)".*?>/i);function g(C,B,A,x,z){var y=urlSegradaPictogramSearch+encodeURIComponent(z);e.getJSON(y,function(E){var D=[];e.each(E,function(F,G){var H=e("<div/>").text(G.title).html();D.push('<div class="col-xs-1 sg-no-padding-right"><a class="sg-pictogram-modal-link" href="#" data-id="'+G.id+'" data-uid="'+G.uid+'" title="'+H+'"><img src="'+urlSegradaPictogramFile+G.uid+'" width="24" height="24" alt="'+H+'" /></a></div>')});B.html("<div class='row'>"+D.join("")+"</div>");e("a",B).click(function(I){var H=e(this).attr("data-id");var G=e(this).attr("data-uid");var F=e("<div/>").text(e(this).attr("title")).html();e("#value-"+A,x).val(H);e("#preview-"+A,x).html('<img src="'+urlSegradaPictogramFile+G+'" width="24" height="24" alt="'+F+'" /> '+F);e("#clear-"+A,x).show();I.preventDefault();C.modal("hide")})}).fail(function(){alert("ERROR")})}function n(x){e.get(x,function(B){var A=B.match(m);if(A!=null&&A.length>=2){e("#"+A[2]).remove()}var z=e("#sg-data");z.prepend(B);var y=z.children(":first");p(y);e("html, body").animate({scrollTop:y.offset().top},500)}).fail(function(){alert("ERROR")})}function p(x){x=x||e("body");e(".sg-data").addClass("sg-dynamic-data");e(".sg-headbox-right").show();e(".sg-dynamic-hide").hide();e(".sg-data-add",x).click(function(z){n(e(this).attr("href"));z.preventDefault()});e(".sg-control-form",x).ajaxForm({beforeSubmit:function(z,B,C){var D=B.attr("data-target-id");if(typeof D=="undefined"||D==null||D.length==0){D="#sg-control";i()}var A=e(D);A.wrapInner("<div class='sg-disabled'></div>");A.prepend(e("#sg-wait").html());return true},success:function(B,D,E,A){var C=A.attr("data-target-id");if(typeof C=="undefined"||C==null||C.length==0){C="#sg-control"}var z=e(C);z.html(B);p(z)},error:function(B,D,E,A){var C=A.attr("data-target-id");if(typeof C=="undefined"||C==null||C.length==0){C="#sg-control"}var z=e(C);z.html(B.statusText);alert("Error "+B.status+"\n"+B.statusText)}});e(".sg-submit-form",x).change(function(){e(this).closest("form").submit()});e(".sg-control-set",x).click(function(C){var B=e(this);var A=B.attr("data-target-id");if(typeof A=="undefined"||A==null||A.length==0){A="#sg-control";i()}var z=e(A);z.wrapInner("<div class='sg-disabled'></div>");z.prepend(e("#sg-wait").html());e.get(B.attr("href"),function(D){z.html(D);p(z)}).fail(function(){alert("ERROR")});C.preventDefault()});e("[data-data-dblclick]",x).dblclick(function(){e.get(e(this).attr("data-data-dblclick"),function(C){var B=C.match(m);if(B!=null&&B.length>=2){e("#"+B[2]).remove()}var A=e("#sg-data");A.prepend(C);var z=A.children(":first");p(z);e("html, body").animate({scrollTop:z.offset().top},500)}).fail(function(){alert("ERROR")})});e("tr [data-confirm]",x).click(function(A){var z=e(this);if(confirm(z.attr("data-confirm"))){var B=z.closest("tr");B.addClass("sg-disabled");e.get(z.attr("href"),function(C){B.slideUp("fast",function(){B.remove()})}).fail(function(){alert("ERROR")})}A.preventDefault()});e(".sg-control-confirm",x).click(function(B){var A=e(this);if(confirm(A.attr("data-confirm"))){var z=e("#"+A.attr("data-target"));z.addClass("sg-disabled");e.get(A.attr("href"),function(C){z.fadeOut("slow",function(){z.remove()})}).fail(function(){alert("ERROR")})}B.preventDefault()});e(".sg-replace-content",x).on("shown.bs.tab",function(B){var A=e(e(this).attr("href"));var z=e(this).attr("data-url");e.get(z,function(C){A.html(C);p(A)}).fail(function(){alert("ERROR")});e(this).removeClass("sg-replace-content");e(this).unbind("shown.bs.tab")});e(".sg-data-close",x).click(function(z){e(this).parent().parent().fadeOut("fast",function(){e(this).remove()})});e("input.sg-fileupload",x).fileinput({showUpload:false});e("input.sg-fileupload-small",x).fileinput({showUpload:false,previewSettings:{image:{width:"auto",height:"24px"}}});e(".sg-pictogram-modal",x).on("shown.bs.modal",function(){var C=e(this);var B=C.attr("id");var A=e("#container-"+B,C);var z=e("#filter-"+B,C);z.on("input propertychange paste",function(){g(C,A,B,x,e(this).val())}).onEnter(function(){var E=e(".sg-pictogram-modal-link",A).first();if(E.length>0){var G=E.attr("data-id");var F=E.attr("data-id");var D=e("<div/>").text(E.attr("title")).html();e("#value-"+B,x).val(G);e("#preview-"+B,x).html('<img src="'+urlSegradaPictogramFile+F+'" width="24" height="24" alt="'+D+'" /> '+D);e("#clear-"+B,x).show();C.modal("hide")}});if(z.val()===""){g(C,A,B,x,"")}});e(".sg-pictogram-chooser",x).click(function(z){e("#"+e(this).attr("data-id")).modal("show");z.preventDefault()});e(".sg-pictogram-clearer",x).click(function(A){var z=e(this).attr("data-id");e("#value-"+z,x).val("");e("#preview-"+z,x).html("");e(this).hide();A.preventDefault()});e(".sg-source-ref-modal",x).on("shown.bs.modal",function(){var B=e(this);var A=B.attr("id");var z=e(".modal-body",B);e.get(B.attr("data-href"),function(C){z.html(C);e("form",z).ajaxForm({beforeSubmit:function(D,E,F){E.wrapInner("<div class='sg-disabled'></div>");E.prepend(e("#sg-wait").html());return true},success:function(E,G,H,D){var F=e(B.attr("data-target"));F.html(E);p(F);B.modal("hide")},error:function(E,F,G,D){alert("Error "+E.status+"\n"+E.statusText)}})}).fail(function(){alert("ERROR")})}).on("hidden.bs.modal",function(){e(".modal-body",e(this)).html(e("#sg-wait").html())});e(".sg-source-ref-editor",x).click(function(A){var z=e("#"+e(this).attr("data-id"));z.attr("data-href",e(this).attr("href"));z.modal("show");A.preventDefault()});e(".sg-taglist-contract",x).each(function(){var z=e("span",e(this));if(z.length>1){z.hide().filter(":first-child").show().after('<span class="sg-tag-show label label-default"><i class="fa fa-plus"></i></span>');e("span.sg-tag-show",e(this)).click(function(){e(this).remove();z.show()})}});e("select.sg-colorpicker",x).simplepicker({theme:"fontawesome"});e("select.sg-tags",x).each(function(){var z=e(this);z.tagsinput({trimValue:true,confirmKeys:[13],typeaheadjs:{name:"tags",displayKey:"title",valueKey:"title",source:j.ttAdapter()}});z.on("itemRemoved",function(A){z.find('option[value="'+A.item+'"]').remove()})});e("input.sg-node-search",x).each(function(){var A=e(this);var z=e("#"+A.attr("data-id"));A.typeahead({hint:true,highlight:true,minLength:1},{name:"node",displayKey:"title",valueKey:"id",source:l.ttAdapter()}).bind("typeahead:selected",function(C,B){z.val(B.id)}).bind("keyup",function(){if(!this.value){z.val("")}})});e("input.sg-file-search",x).each(function(){var A=e(this);var z=e("#"+A.attr("data-id"));A.typeahead({hint:true,highlight:true,minLength:1},{name:"file",displayKey:"title",valueKey:"id",source:o.ttAdapter()}).bind("typeahead:selected",function(C,B){z.val(B.id)}).bind("keyup",function(){if(!this.value){z.val("")}})});e("input.sg-source-search",x).each(function(){var A=e(this);var z=e("#"+A.attr("data-id"));A.typeahead({hint:true,highlight:true,minLength:1},{name:"source",displayKey:"title",valueKey:"id",source:v.ttAdapter()}).bind("typeahead:selected",function(C,B){z.val(B.id)}).bind("keyup",function(){if(!this.value){z.val("")}})});e(".sg-link-external",x).click(function(B){var z=e(this).attr("href");var A=window.open(z,"_blank");A.focus();B.preventDefault()});e("form.sg-data-form",x).ajaxForm({beforeSubmit:function(z,A,B){e(":input",A).attr("disabled",true);e("button.btn-primary",A).append(" "+e("#sg-wait-btn").html());return true},success:function(B,D,E,z){var C=z.attr("data-id");if(typeof C!=="undefined"){C=e("#"+C)}C=C||z;C.replaceWith(B);var A=B.match(m);if(A!=null&&A.length>=2){p(e("#"+A[2]))}},error:function(A,B,C,z){e(":input",z).attr("disabled",false);alert("Error "+A.status+"\n"+A.statusText)}});e("form.sg-simple-form",x).ajaxForm({beforeSubmit:function(z,A,B){e(":input",A).attr("disabled",true);var C=A.attr("data-id");if(typeof C!=="undefined"){C=e("#"+C)}C=C||A;C.html(e("#sg-wait"));return true},success:function(A,C,D,z){var B=z.attr("data-id");if(typeof B!=="undefined"){B=e("#"+B)}B=B||z;B.html(A);e(":input",z).attr("disabled",false)},error:function(A,B,C,z){e(":input",z).attr("disabled",false);alert("Error "+A.status+"\n"+A.statusText)}});e(".sg-periods").each(function(){var z=e(this);var B=z.attr("id");var A=e(".sg-period-form",z);e(".sg-period-add",z).click(function(D){e(this).hide();var C=e(".sg-period-form-add",z);C.show();e(".sg-period-form-period",C).change(function(E){if(e(this).is(":checked")){e(".sg-period-toggle",C).show()}else{e(".sg-period-toggle",C).hide()}});D.preventDefault()});A.ajaxForm({beforeSubmit:function(C,D,E){z.addClass("disabled");return true},success:function(D,E,F,C){z.replaceWith(D);p(e("#"+B))},error:function(D,E,F,C){z.removeClass("disabled");alert("Error "+D.status+"\n"+D.statusText)}})});e(".sg-ajax-modal",x).click(function(C){var A=e("#sg-modal");var z=e(".modal-body-inner",A);var B=e(".modal-loading",A);e("h4",A).html(e(this).attr("data-title"));z.html("");z.hide();B.show();A.modal("show");e.get(e(this).attr("href"),function(D){B.hide();z.html(D);z.show();p(z)}).fail(function(){alert("ERROR")});C.preventDefault()});e(".sg-ajax-modal-form",x).ajaxForm({beforeSubmit:function(z,A,D){var C=e("#sg-modal");var B=e(".modal-body-inner",C);var E=e(".modal-loading",C);B.hide();E.show();return true},success:function(D,E,F,z){var B=e("#sg-modal");var A=e(".modal-body-inner",B);var C=e(".modal-loading",B);A.html(D);A.show();C.hide();p(A);B=e("#sg-modal");e(".sg-update-period",B).each(function(){var H=e(this).attr("data-id");var I=e(H);if(I.length>0){for(var G=0;G<3;G++){e("td:eq("+G+")",I).html(e("div:eq("+G+")",e(this)).html())}}})},error:function(D,E,F,z){var B=e("#sg-modal");var A=e(".modal-body-inner",B);var C=e(".modal-loading",B);A.html(D);A.show();C.hide();p(A)}});e("a.sg-graph-update",x).click(function(z){u(e(this).attr("href"));z.preventDefault()});e("div.sg-tag-hierarchy",x).each(function(){var E=e(this);var z=e(".sg-tag-hierarchy-graph",E);e(".sg-child-tags",E).hide();z.addClass("sg-margin-top sg-margin-bottom");var F=e(".sg-tag-hierarchy-data",E);var B=F.attr("data-center");var I=0;var H=0;var A=[];var D=[];e("div",F).each(function(){var N=e(this);var L=N.attr("data-id");var M=N.attr("data-level");A.push({id:L,label:N.html(),level:M,url:N.attr("data-url")});if(M=="0"){D.push({from:L,to:B});I++}else{if(M=="2"){D.push({from:B,to:L});H++}}});var G=I>H?(I==0?1:I):H;z.css({width:"100%",height:(G*50)+"px",border:"1px solid #ccc"});var C={nodes:new vis.DataSet(A),edges:new vis.DataSet(D)};A=null;D=null;var K={edges:{smooth:{type:"cubicBezier",forceDirection:"horizontal",roundness:0.6}},nodes:{shape:"box"},layout:{hierarchical:{direction:"LR"}}};var J=new vis.Network(z.get(0),C,K);J.on("doubleClick",function(N){var L=null;if(N.nodes.length>0){var M=C.nodes.get(N.nodes[0]);if(M!=null&&M.url!=null){L=M.url}}if(L!=null){n(L)}})});for(var y=0;y<afterAjaxHooks.length;y++){afterAjaxHooks[y](x)}}function d(){if(!k){k=true;var x=document.getElementById("sg-graph");var z={nodes:h,edges:s};var y={locale:e("html").attr("lang"),locales:{de:{edit:"Änderungsmodus",del:"Lösche Auswahl",back:"Zurück",addNode:"Knoten hinzufügen",addEdge:"Verknüpfung hinzufügen",editNode:"Knoten editieren",editEdge:"Verknüpfung editieren",addDescription:"Klicke auf eine freie Stelle, um einen neuen Knoten zu plazieren.",edgeDescription:"Klicke auf einen Knoten und ziehe die Verknüpfung zu einem anderen Knoten, um diese zu verbinden.",editEdgeDescription:"Klicke auf die Verbindungspunkte und ziehe diese auf einen Knoten, um sie zu verbinden.",createEdgeError:"Es ist nicht möglich, Verknüpfungen mit Clustern zu verbinden.",deleteClusterError:"Cluster können nicht gelöscht werden.",editClusterError:"Cluster können nicht editiert werden."},en:{edit:"Toggle edit",del:"Delete selected",back:"Back",addNode:"Add Node",addEdge:"Add Relation",editNode:"Edit Node",editEdge:"Edit Relation",addDescription:"Click in an empty space to place a new node.",edgeDescription:"Click on a node and drag the relation to another node to connect them.",editEdgeDescription:"Click on the control points and drag them to a node to connect to it.",createEdgeError:"Cannot link relations to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."}},manipulation:{enabled:true,addNode:false,addEdge:function(B,C){var A=urlSegradaRelationAdd.replace("XFROMX",B.from.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("XTOX",B.to.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("&amp;","&");n(A);return false},editNode:function(A,B){return false},editEdge:function(A,B){return false},deleteNode:function(A,B){return false},deleteEdge:function(A,B){return false}},nodes:{shape:"icon",color:{border:"#000",background:"#fff"}},edges:{font:{size:10},labelHighlightBold:false,selectionWidth:0,arrows:{to:true},smooth:{type:"cubicBezier"}},groups:{node:{icon:{code:"\uf192",color:"#000000"}},tag:{shape:"box",color:{border:"#5bc0de",background:"#5bc0de",highlight:{background:"#2B7CE9"}},font:{color:"#ffffff",size:12}}},physics:{barnesHut:{springLength:120}}};b=new vis.Network(x,z,y);b.on("doubleClick",function(D){var A=null;if(D.nodes.length>0){var C=h.get(D.nodes[0]);if(C!=null&&C.url!=null){A=C.url}}else{if(D.edges.length>0){var B=s.get(D.edges[0]);if(B!=null&&B.url!=null){A=B.url}}}if(A!=null){n(A)}})}}function i(){var x=e("#sg-toggle-graph");if(x.hasClass("active")){x.removeClass("active");e(".fa-share-alt-square",x).addClass("fa-share-alt").removeClass("fa-share-alt-square");b.storePositions();e("#sg-graph-container").hide();e("#sg-control").show();b.destroy();k=false}}function r(){var x=e("#sg-toggle-graph");if(!x.hasClass("active")){x.addClass("active");e(".fa-share-alt",x).addClass("fa-share-alt-square").removeClass("fa-share-alt");e("#sg-control").hide();e("#sg-graph-container").show();d()}}function u(y){if(y==null){alert("Null url!");return}r();w();var A=[];var C=[];var x=h.get({fields:["id"]});var z;for(z=0;z<x.length;z++){A.push(x[z].id)}x=s.get({fields:["id"]});for(z=0;z<x.length;z++){C.push(x[z].id)}var B=e("#sg-graph-container").attr("data-csrf");e.ajax({url:y,type:"POST",dataType:"json",headers:{"Content-Type":"application/json","X-CSRF-Token":B},data:JSON.stringify({nodes:A,edges:C}),success:function(E,F,D){a();if(E==null){alert("NULL data");return}if(E.error!=null){alert(E.error);return}if(E.nodes!=null&&E.nodes.length>0){h.update(E.nodes)}if(E.edges!=null&&E.edges.length>0){s.update(E.edges)}if(E.removeNodes!=null&&E.removeNodes.length>0){h.remove(E.removeNodes)}if(E.removeEdges!=null&&E.removeEdges.length>0){s.remove(E.removeEdges)}if(E.highlightNode!=null){b.unselectAll();b.selectNodes([E.highlightNode],false)}b.fit()}})}function f(){s.clear();h.clear();c="";t=""}function w(){var x=e("#sg-graph");x.css("background",'url("'+x.attr("data-bg")+'") no-repeat center center')}function a(){e("#sg-graph").css("background","transparent")}e.event.special.destroyed={remove:function(x){if(x.handler){x.handler()}}};e(document).ready(function(){e("#sg-close-all").click(function(x){e(".sg-data").fadeOut("fast",function(){e(this).remove()});x.preventDefault()});e(".sg-locale").click(function(x){e.get(e(this).attr("href"),function(z){var y=e("#sg-base").html();if(z!=""){window.location.href=y}}).fail(function(){alert("ERROR")});x.preventDefault()});j.initialize();e("#sg-toggle-graph").click(function(x){if(e(this).hasClass("active")){i()}else{r()}x.preventDefault()});e("#sg-graph-action-remove").click(function(y){var x=b.getSelection();if(x.edges.length>0){s.remove(x.edges)}if(x.nodes.length>0){h.remove(x.nodes)}y.preventDefault()});e("#sg-graph-action-restart").click(function(x){f();x.preventDefault()});e("#sg-graph-action-reload").click(function(x){b.destroy();k=false;d();x.preventDefault()});e("#sg-graph-action-fit").click(function(x){b.fit();x.preventDefault()});e("#sg-graph-close").click(function(x){i();x.preventDefault()});e("#sg-graph-action-load").click(function(x){e("#sg-graph-modal-load").modal();x.preventDefault()});e("#sg-graph-action-save").click(function(y){if(h.length>0){e("#title-sg-graph-save").val(t!=null?t:"");var x=e("#save-as-new-sg-graph-save").parent().parent().parent();if(c!=null){x.show()}else{x.hide()}e("#sg-graph-modal-save").modal()}y.preventDefault()});e("#sg-graph-modal-load").on("shown.bs.modal",function(){var z=e(this);var y=e(".modal-body",z);y.html(e("#sg-wait").html());var x=z.attr("data-url");e.get(x,function(C){var A=z.attr("data-get-url");var B="";C.forEach(function(D){B+="<li><a href='"+A+D.uid+"' data-uid='"+D.uid+"'>"+D.title+"</a></li>"});if(B!=""){B="<ul>"+B+"</ul>"}y.html(B);e("a",y).click(function(D){f();u(e(this).attr("href"));t=e(this).html();c=e(this).attr("data-uid");z.modal("hide");D.preventDefault()})})});e("#sg-graph-modal-save-frm").submit(function(B){B.preventDefault();var C=e("#title-sg-graph-save").val();var z=c;if(c!=null&&e("#save-as-new-sg-graph-save").is(":checked")){z=null}b.storePositions();var y=[];var x=[];h.forEach(function(D){y.push({id:D.id,x:D.x,y:D.y,group:D.group})});s.forEach(function(D){x.push({id:D.id,group:D.group})});var A={};e.post(e(this).attr("action"),{_csrf:e("#sg-graph-container").attr("data-csrf"),uid:z,title:C,type:"graph",data:JSON.stringify({nodes:y,edges:x})},function(D){t=C;c=D}).fail(function(){alert("ERROR")});e("#sg-graph-modal-save").modal("hide")});p(e("body"))})})(jQuery);