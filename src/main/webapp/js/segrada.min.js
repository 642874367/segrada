function escapeHTML(a){if(typeof a=="string"){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}return""}(function(d){var h=new Bloodhound({datumTokenizer:function(u){return Bloodhound.tokenizers.whitespace(u.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaTagSearch+"%QUERY"}});var j=new Bloodhound({datumTokenizer:function(u){return Bloodhound.tokenizers.whitespace(u.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:urlSegradaNodeSearch,replace:function(v,w){var x=v+w;var u=d(".sg-node-search").filter(":focus");var z=d("#"+u.attr("data-select-id")+" option").filter(":selected");var y=z.attr(u.attr("data-attr"));if(y!=null&&y.length>0){x+="&tags="+encodeURIComponent(y)}return x}}});var m=new Bloodhound({datumTokenizer:function(u){return Bloodhound.tokenizers.whitespace(u.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaFileSearch+"%QUERY"}});var t=new Bloodhound({datumTokenizer:function(u){return Bloodhound.tokenizers.whitespace(u.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:urlSegradaSourceSearch+"%QUERY"}});function o(u){return u.replace(/;jsessionid=([^?]*)/,"")}urlSegradaPictogramSearch=o(urlSegradaPictogramSearch);urlSegradaPictogramFile=o(urlSegradaPictogramFile);urlSegradaTagSearch=o(urlSegradaTagSearch);urlSegradaNodeSearch=o(urlSegradaNodeSearch);urlSegradaFileSearch=o(urlSegradaFileSearch);urlSegradaSourceSearch=o(urlSegradaSourceSearch);urlSegradaRelationAdd=o(urlSegradaRelationAdd);var i=false;var f=new vis.DataSet([]);var q=new vis.DataSet([]);var a=null;var r=null;var b=null;d.fn.onEnter=function(u){this.bind("keypress",function(v){if(v.keyCode==13){u.apply(this,[v])}});return this};var k=new RegExp(/<([^\s]+).*?id="([^"]*?)".*?>/i);function e(z,y,x,u,w){var v=urlSegradaPictogramSearch+encodeURIComponent(w);d.getJSON(v,function(B){var A=[];d.each(B,function(C,D){var E=d("<div/>").text(D.title).html();A.push('<div class="col-xs-1 sg-no-padding-right"><a class="sg-pictogram-modal-link" href="#" data-id="'+D.id+'" data-uid="'+D.uid+'" title="'+E+'"><img src="'+urlSegradaPictogramFile+D.uid+'" width="24" height="24" alt="'+E+'" /></a></div>')});y.html("<div class='row'>"+A.join("")+"</div>");d("a",y).click(function(F){var E=d(this).attr("data-id");var D=d(this).attr("data-uid");var C=d("<div/>").text(d(this).attr("title")).html();d("#value-"+x,u).val(E);d("#preview-"+x,u).html('<img src="'+urlSegradaPictogramFile+D+'" width="24" height="24" alt="'+C+'" /> '+C);d("#clear-"+x,u).show();F.preventDefault();z.modal("hide")})}).fail(function(){alert("ERROR")})}function l(u){d.get(u,function(y){var x=y.match(k);if(x!=null&&x.length>=2){d("#"+x[2]).remove()}var w=d("#sg-data");w.prepend(y);var v=w.children(":first");n(v);d("html, body").animate({scrollTop:v.offset().top},500)}).fail(function(){alert("ERROR")})}function n(u){u=u||d("body");d(".sg-data").addClass("sg-dynamic-data");d(".sg-headbox-right").show();d(".sg-dynamic-hide").hide();d(".sg-data-add",u).click(function(w){l(d(this).attr("href"));w.preventDefault()});d(".sg-control-form",u).ajaxForm({beforeSubmit:function(w,y,z){var A=y.attr("data-target-id");if(typeof A=="undefined"||A==null||A.length==0){A="#sg-control";g()}var x=d(A);x.wrapInner("<div class='sg-disabled'></div>");x.prepend(d("#sg-wait").html());return true},success:function(y,A,B,x){var z=x.attr("data-target-id");if(typeof z=="undefined"||z==null||z.length==0){z="#sg-control"}var w=d(z);w.html(y);n(w)},error:function(y,A,B,x){var z=x.attr("data-target-id");if(typeof z=="undefined"||z==null||z.length==0){z="#sg-control"}var w=d(z);w.html(y.statusText);alert("Error "+y.status+"\n"+y.statusText)}});d(".sg-submit-form",u).change(function(){d(this).closest("form").submit()});d(".sg-control-set",u).click(function(z){var y=d(this);var x=y.attr("data-target-id");if(typeof x=="undefined"||x==null||x.length==0){x="#sg-control";g()}var w=d(x);w.wrapInner("<div class='sg-disabled'></div>");w.prepend(d("#sg-wait").html());d.get(y.attr("href"),function(A){w.html(A);n(w)}).fail(function(){alert("ERROR")});z.preventDefault()});d("[data-data-dblclick]",u).dblclick(function(){d.get(d(this).attr("data-data-dblclick"),function(z){var y=z.match(k);if(y!=null&&y.length>=2){d("#"+y[2]).remove()}var x=d("#sg-data");x.prepend(z);var w=x.children(":first");n(w);d("html, body").animate({scrollTop:w.offset().top},500)}).fail(function(){alert("ERROR")})});d("tr [data-confirm]",u).click(function(x){var w=d(this);if(confirm(w.attr("data-confirm"))){var y=w.closest("tr");y.addClass("sg-disabled");d.get(w.attr("href"),function(z){y.slideUp("fast",function(){y.remove()})}).fail(function(){alert("ERROR")})}x.preventDefault()});d(".sg-control-confirm",u).click(function(y){var x=d(this);if(confirm(x.attr("data-confirm"))){var w=d("#"+x.attr("data-target"));w.addClass("sg-disabled");d.get(x.attr("href"),function(z){w.fadeOut("slow",function(){w.remove()})}).fail(function(){alert("ERROR")})}y.preventDefault()});d(".sg-replace-content",u).on("shown.bs.tab",function(y){var x=d(d(this).attr("href"));var w=d(this).attr("data-url");d.get(w,function(z){x.html(z);n(x)}).fail(function(){alert("ERROR")});d(this).removeClass("sg-replace-content");d(this).unbind("shown.bs.tab")});d(".sg-data-close",u).click(function(w){d(this).parent().parent().fadeOut("fast",function(){d(this).remove()})});d("input.sg-fileupload",u).fileinput({showUpload:false});d("input.sg-fileupload-small",u).fileinput({showUpload:false,previewSettings:{image:{width:"auto",height:"24px"}}});d(".sg-pictogram-modal").on("shown.bs.modal",function(){var z=d(this);var y=z.attr("id");var x=d("#container-"+y,z);var w=d("#filter-"+y,z);w.on("input propertychange paste",function(){e(z,x,y,u,d(this).val())}).onEnter(function(){var B=d(".sg-pictogram-modal-link",x).first();if(B.length>0){var D=B.attr("data-id");var C=B.attr("data-id");var A=d("<div/>").text(B.attr("title")).html();d("#value-"+y,u).val(D);d("#preview-"+y,u).html('<img src="'+urlSegradaPictogramFile+C+'" width="24" height="24" alt="'+A+'" /> '+A);d("#clear-"+y,u).show();z.modal("hide")}});if(w.val()===""){e(z,x,y,u,"")}});d(".sg-pictogram-chooser",u).click(function(w){d("#"+d(this).attr("data-id")).modal("show");w.preventDefault()});d(".sg-pictogram-clearer",u).click(function(x){var w=d(this).attr("data-id");d("#value-"+w,u).val("");d("#preview-"+w,u).html("");d(this).hide();x.preventDefault()});d(".sg-source-ref-modal").on("shown.bs.modal",function(){var y=d(this);var x=y.attr("id");var w=d(".modal-body",y);d.get(y.attr("data-href"),function(z){w.html(z);d("form",w).ajaxForm({beforeSubmit:function(A,B,C){B.wrapInner("<div class='sg-disabled'></div>");B.prepend(d("#sg-wait").html());return true},success:function(B,D,E,A){var C=d(y.attr("data-target"));C.html(B);n(C);y.modal("hide")},error:function(B,C,D,A){alert("Error "+B.status+"\n"+B.statusText)}})}).fail(function(){alert("ERROR")})}).on("hidden.bs.modal",function(){d(".modal-body",d(this)).html(d("#sg-wait").html())});d(".sg-source-ref-editor",u).click(function(x){var w=d("#"+d(this).attr("data-id"));w.attr("data-href",d(this).attr("href"));w.modal("show");x.preventDefault()});d(".sg-taglist-contract",u).each(function(){var w=d("span",d(this));if(w.length>1){w.hide().filter(":first-child").show().after('<span class="sg-tag-show label label-default"><i class="fa fa-plus"></i></span>');d("span.sg-tag-show",d(this)).click(function(){d(this).remove();w.show()})}});d("select.sg-colorpicker",u).simplepicker({theme:"fontawesome"});d("select.sg-tags",u).each(function(){var w=d(this);w.tagsinput({trimValue:true,confirmKeys:[13],typeaheadjs:{name:"tags",displayKey:"title",valueKey:"title",source:h.ttAdapter()}});w.on("itemRemoved",function(x){w.find('option[value="'+x.item+'"]').remove()})});d("input.sg-node-search",u).each(function(){var x=d(this);var w=d("#"+x.attr("data-id"));x.typeahead({hint:true,highlight:true,minLength:1},{name:"node",displayKey:"title",valueKey:"id",source:j.ttAdapter()}).bind("typeahead:selected",function(z,y){w.val(y.id)}).bind("keyup",function(){if(!this.value){w.val("")}})});d("input.sg-file-search",u).each(function(){var x=d(this);var w=d("#"+x.attr("data-id"));x.typeahead({hint:true,highlight:true,minLength:1},{name:"file",displayKey:"title",valueKey:"id",source:m.ttAdapter()}).bind("typeahead:selected",function(z,y){w.val(y.id)}).bind("keyup",function(){if(!this.value){w.val("")}})});d("input.sg-source-search",u).each(function(){var x=d(this);var w=d("#"+x.attr("data-id"));x.typeahead({hint:true,highlight:true,minLength:1},{name:"source",displayKey:"title",valueKey:"id",source:t.ttAdapter()}).bind("typeahead:selected",function(z,y){w.val(y.id)}).bind("keyup",function(){if(!this.value){w.val("")}})});d(".sg-link-external",u).click(function(y){var w=d(this).attr("href");var x=window.open(w,"_blank");x.focus();y.preventDefault()});d("form.sg-data-form",u).ajaxForm({beforeSubmit:function(w,x,y){d(":input",x).attr("disabled",true);d("button.btn-primary",x).append(" "+d("#sg-wait-btn").html());return true},success:function(y,A,B,w){var z=w.attr("data-id");if(typeof z!=="undefined"){z=d("#"+z)}z=z||w;z.replaceWith(y);var x=y.match(k);if(x!=null&&x.length>=2){n(d("#"+x[2]))}},error:function(x,y,z,w){d(":input",w).attr("disabled",false);alert("Error "+x.status+"\n"+x.statusText)}});d("form.sg-simple-form",u).ajaxForm({beforeSubmit:function(w,x,y){d(":input",x).attr("disabled",true);var z=x.attr("data-id");if(typeof z!=="undefined"){z=d("#"+z)}z=z||x;z.html(d("#sg-wait"));return true},success:function(x,z,A,w){var y=w.attr("data-id");if(typeof y!=="undefined"){y=d("#"+y)}y=y||w;y.html(x);d(":input",w).attr("disabled",false)},error:function(x,y,z,w){d(":input",w).attr("disabled",false);alert("Error "+x.status+"\n"+x.statusText)}});d(".sg-periods").each(function(){var w=d(this);var y=w.attr("id");var x=d(".sg-period-form",w);d(".sg-period-add",w).click(function(A){d(this).hide();var z=d(".sg-period-form-add",w);z.show();d(".sg-period-form-period",z).change(function(B){if(d(this).is(":checked")){d(".sg-period-toggle",z).show()}else{d(".sg-period-toggle",z).hide()}});A.preventDefault()});x.ajaxForm({beforeSubmit:function(z,A,B){w.addClass("disabled");return true},success:function(A,B,C,z){w.replaceWith(A);n(d("#"+y))},error:function(A,B,C,z){w.removeClass("disabled");alert("Error "+A.status+"\n"+A.statusText)}})});d(".sg-ajax-modal",u).click(function(z){var x=d("#sg-modal");var w=d(".modal-body-inner",x);var y=d(".modal-loading",x);d("h4",x).html(d(this).attr("data-title"));w.html("");w.hide();y.show();x.modal("show");d.get(d(this).attr("href"),function(A){y.hide();w.html(A);w.show();n(w)}).fail(function(){alert("ERROR")});z.preventDefault()});d(".sg-ajax-modal-form",u).ajaxForm({beforeSubmit:function(w,x,A){var z=d("#sg-modal");var y=d(".modal-body-inner",z);var B=d(".modal-loading",z);y.hide();B.show();return true},success:function(A,B,C,w){var y=d("#sg-modal");var x=d(".modal-body-inner",y);var z=d(".modal-loading",y);x.html(A);x.show();z.hide();n(x);y=d("#sg-modal");d(".sg-update-period",y).each(function(){var E=d(this).attr("data-id");var F=d(E);if(F.length>0){for(var D=0;D<3;D++){d("td:eq("+D+")",F).html(d("div:eq("+D+")",d(this)).html())}}})},error:function(A,B,C,w){var y=d("#sg-modal");var x=d(".modal-body-inner",y);var z=d(".modal-loading",y);x.html(A);x.show();z.hide();n(x)}});d("a.sg-graph-update",u).click(function(w){s(d(this).attr("href"));w.preventDefault()});d("div.sg-tag-hierarchy",u).each(function(){var B=d(this);var w=d(".sg-tag-hierarchy-graph",B);d(".sg-child-tags",B).hide();w.addClass("sg-margin-top sg-margin-bottom");var C=d(".sg-tag-hierarchy-data",B);var y=C.attr("data-center");var F=0;var E=0;var x=[];var A=[];d("div",C).each(function(){var K=d(this);var I=K.attr("data-id");var J=K.attr("data-level");x.push({id:I,label:K.html(),level:J,url:K.attr("data-url")});if(J=="0"){A.push({from:I,to:y});F++}else{if(J=="2"){A.push({from:y,to:I});E++}}});var D=F>E?(F==0?1:F):E;w.css({width:"100%",height:(D*50)+"px",border:"1px solid #ccc"});var z={nodes:new vis.DataSet(x),edges:new vis.DataSet(A)};x=null;A=null;var H={edges:{smooth:{type:"cubicBezier",forceDirection:"horizontal",roundness:0.6}},nodes:{shape:"box"},layout:{hierarchical:{direction:"LR"}}};var G=new vis.Network(w.get(0),z,H);G.on("doubleClick",function(K){var I=null;if(K.nodes.length>0){var J=z.nodes.get(K.nodes[0]);if(J!=null&&J.url!=null){I=J.url}}if(I!=null){l(I)}})});for(var v=0;v<afterAjaxHooks.length;v++){afterAjaxHooks[v](u)}}function c(){if(!i){i=true;var u=document.getElementById("sg-graph");var w={nodes:f,edges:q};var v={locale:d("html").attr("lang"),locales:{de:{edit:"Änderungsmodus",del:"Lösche Auswahl",back:"Zurück",addNode:"Knoten hinzufügen",addEdge:"Verknüpfung hinzufügen",editNode:"Knoten editieren",editEdge:"Verknüpfung editieren",addDescription:"Klicke auf eine freie Stelle, um einen neuen Knoten zu plazieren.",edgeDescription:"Klicke auf einen Knoten und ziehe die Verknüpfung zu einem anderen Knoten, um diese zu verbinden.",editEdgeDescription:"Klicke auf die Verbindungspunkte und ziehe diese auf einen Knoten, um sie zu verbinden.",createEdgeError:"Es ist nicht möglich, Verknüpfungen mit Clustern zu verbinden.",deleteClusterError:"Cluster können nicht gelöscht werden.",editClusterError:"Cluster können nicht editiert werden."},en:{edit:"Toggle edit",del:"Delete selected",back:"Back",addNode:"Add Node",addEdge:"Add Relation",editNode:"Edit Node",editEdge:"Edit Relation",addDescription:"Click in an empty space to place a new node.",edgeDescription:"Click on a node and drag the relation to another node to connect them.",editEdgeDescription:"Click on the control points and drag them to a node to connect to it.",createEdgeError:"Cannot link relations to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."}},manipulation:{enabled:true,addNode:false,addEdge:function(y,z){var x=urlSegradaRelationAdd.replace("XFROMX",y.from.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("XTOX",y.to.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("&amp;","&");l(x);return false},editNode:function(x,y){return false},editEdge:function(x,y){return false},deleteNode:function(x,y){return false},deleteEdge:function(x,y){return false}},nodes:{shape:"icon",color:{border:"#000",background:"#fff"}},edges:{font:{size:10},labelHighlightBold:false,selectionWidth:0,arrows:{to:true},smooth:{type:"cubicBezier"}},groups:{node:{icon:{code:"\uf192",color:"#000000"}},tag:{shape:"box",color:{border:"#5bc0de",background:"#5bc0de",highlight:{background:"#2B7CE9"}},font:{color:"#ffffff",size:12}}},physics:{barnesHut:{springLength:120}}};a=new vis.Network(u,w,v);a.on("doubleClick",function(A){var x=null;if(A.nodes.length>0){var z=f.get(A.nodes[0]);if(z!=null&&z.url!=null){x=z.url}}else{if(A.edges.length>0){var y=q.get(A.edges[0]);if(y!=null&&y.url!=null){x=y.url}}}if(x!=null){l(x)}})}}function g(){var u=d("#sg-toggle-graph");if(u.hasClass("active")){u.removeClass("active");d(".fa-share-alt-square",u).addClass("fa-share-alt").removeClass("fa-share-alt-square");a.storePositions();d("#sg-graph-container").hide();d("#sg-control").show();a.destroy();i=false}}function p(){var u=d("#sg-toggle-graph");if(!u.hasClass("active")){u.addClass("active");d(".fa-share-alt",u).addClass("fa-share-alt-square").removeClass("fa-share-alt");d("#sg-control").hide();d("#sg-graph-container").show();c()}}function s(v){if(v==null){alert("Null url!");return}p();var x=[];var z=[];var u=f.get({fields:["id"]});for(var w=0;w<u.length;w++){x.push(u[w].id)}u=q.get({fields:["id"]});for(var w=0;w<u.length;w++){z.push(u[w].id)}var y=d("#sg-graph-container").attr("data-csrf");d.ajax({url:v,type:"POST",dataType:"json",headers:{"Content-Type":"application/json","X-CSRF-Token":y},data:JSON.stringify({nodes:x,edges:z}),success:function(B,C,A){if(B==null){alert("NULL data");return}if(B.error!=null){alert(B.error);return}if(B.nodes!=null&&B.nodes.length>0){f.update(B.nodes)}if(B.edges!=null&&B.edges.length>0){q.update(B.edges)}if(B.removeNodes!=null&&B.removeNodes.length>0){f.remove(B.removeNodes)}if(B.removeEdges!=null&&B.removeEdges.length>0){q.remove(B.removeEdges)}if(B.highlightNode!=null){a.unselectAll();a.selectNodes([B.highlightNode],false)}a.fit()}})}d.event.special.destroyed={remove:function(u){if(u.handler){u.handler()}}};d(document).ready(function(){d("#sg-close-all").click(function(u){d(".sg-data").fadeOut("fast",function(){d(this).remove()});u.preventDefault()});d(".sg-locale").click(function(u){d.get(d(this).attr("href"),function(w){var v=d("#sg-base").html();if(w!=""){window.location.href=v}}).fail(function(){alert("ERROR")});u.preventDefault()});h.initialize();d("#sg-toggle-graph").click(function(u){if(d(this).hasClass("active")){g()}else{p()}u.preventDefault()});d("#sg-graph-action-remove").click(function(v){var u=a.getSelection();if(u.edges.length>0){q.remove(u.edges)}if(u.nodes.length>0){f.remove(u.nodes)}v.preventDefault()});d("#sg-graph-action-restart").click(function(u){q.clear();f.clear();b="";r="";u.preventDefault()});d("#sg-graph-action-reload").click(function(u){a.destroy();i=false;c();u.preventDefault()});d("#sg-graph-action-fit").click(function(u){a.fit();u.preventDefault()});d("#sg-graph-close").click(function(u){g();u.preventDefault()});d("#sg-graph-action-load").click(function(u){d("#sg-graph-modal-load").modal();u.preventDefault()});d("#sg-graph-action-save").click(function(v){if(f.length>0){d("#title-sg-graph-save").val(r!=null?r:"");var u=d("#save-as-new-sg-graph-save").parent().parent().parent();if(b!=null){u.show()}else{u.hide()}d("#sg-graph-modal-save").modal()}v.preventDefault()});d("#sg-graph-modal-save-frm").submit(function(y){y.preventDefault();var z=d("#title-sg-graph-save").val();var w=b;if(b!=null&&d("#save-as-new-sg-graph-save").is(":checked")){w=null}a.storePositions();var v=[];var u=[];f.forEach(function(A){v.push({id:A.id,x:A.x,y:A.y,group:A.group})});q.forEach(function(A){u.push({id:A.id,group:A.group})});var x={};d.post(d(this).attr("action"),{_csrf:d("#sg-graph-container").attr("data-csrf"),uid:w,title:z,type:"graph",data:JSON.stringify({nodes:v,edges:u})},function(A){r=z;b=A}).fail(function(){alert("ERROR")});d("#sg-graph-modal-save").modal("hide")});n(d("body"))})})(jQuery);